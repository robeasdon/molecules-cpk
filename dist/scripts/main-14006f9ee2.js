function Grid(){"use strict";this.min=vec3.create(),this.max=vec3.create(),this.cellSize=0,this.numBoxesX=0,this.numBoxesY=0,this.numBoxesZ=0,this.cells=[],this.init=function(e,t,r){this.min=e,this.max=t,this.cellSize=r;var i=this.max[0]-this.min[0],n=this.max[1]-this.min[1],a=this.max[2]-this.min[2],o=Math.ceil(i/this.cellSize)*this.cellSize,u=Math.ceil(n/this.cellSize)*this.cellSize,s=Math.ceil(a/this.cellSize)*this.cellSize;this.numBoxesX=parseInt(o/this.cellSize),this.numBoxesY=parseInt(u/this.cellSize),this.numBoxesZ=parseInt(s/this.cellSize)},this.getObjectGridIndex3D=function(e){var t=parseInt((e[0]-this.min[0])/this.cellSize),r=parseInt((e[1]-this.min[1])/this.cellSize),i=parseInt((e[2]-this.min[2])/this.cellSize);return[t,r,i]},this.getObjectGridIndex1D=function(e){var t=this.getObjectGridIndex3D(e);return parseInt(t[2]*this.numBoxesX*this.numBoxesY+t[1]*this.numBoxesX+t[0])},this.insideGrid=function(e,t,r){return e>=0&&t>=0&&r>=0&&e<this.numBoxesX&&t<this.numBoxesY&&r<this.numBoxesZ},this.getCellMinPoint=function(e,t,r){var i=vec3.create();return i[0]=e*this.cellSize+this.min[0],i[1]=t*this.cellSize+this.min[1],i[2]=r*this.cellSize+this.min[2],i},this.getCellMaxPoint=function(e,t,r){var i=vec3.create();return i[0]=(e+1)*this.cellSize+this.min[0],i[1]=(t+1)*this.cellSize+this.min[1],i[2]=(r+1)*this.cellSize+this.min[2],i}}var Utilities=function(){"use strict";var e={};return e.getEyeRay=function(e,t,r,i){var n=vec4.create();vec4.transformMat4(n,vec4.fromValues(r,i,0,1),t);var a=n[3],o=n[0]/a,u=n[1]/a,s=n[2]/a,c=vec3.fromValues(o,u,s),f=vec3.create();return vec3.subtract(f,c,e),f},e.intersectRaySphere=function(e,t,r,i){var n=vec3.create();vec3.subtract(n,e,r);var a=vec3.dot(t,t),o=2*vec3.dot(n,t),u=vec3.dot(n,n)-i*i,s=o*o-4*a*u;if(s>0){var c=(-o-Math.sqrt(s))/(2*a);if(c>0)return c}return Number.MAX_VALUE},e.intersectRayAABB=function(e,t,r,i){var n=vec3.create();n[0]=1/t[0],n[1]=1/t[1],n[2]=1/t[2];var a=vec3.create();vec3.subtract(a,r,e),vec3.multiply(a,a,n);var o=vec3.create();vec3.subtract(o,i,e),vec3.multiply(o,o,n);var u=vec3.create();u[0]=Math.min(o[0],a[0]),u[1]=Math.min(o[1],a[1]),u[2]=Math.min(o[2],a[2]);var s=vec3.create();s[0]=Math.max(o[0],a[0]),s[1]=Math.max(o[1],a[1]),s[2]=Math.max(o[2],a[2]);var c=vec2.create();c[0]=Math.max(u[0],u[1]),c[1]=Math.max(u[0],u[2]);var f=Math.max(c[0],c[1]);c[0]=Math.min(s[0],s[1]),c[1]=Math.min(s[0],s[2]);var l=Math.min(c[0],c[1]);return{t0:f,t1:l,hit:l>=f}},e.sqDistPointAABB=function(e,t,r){var i=0,n=e[0];return n<t[0]&&(i+=(t[0]-n)*(t[0]-n)),n>r[0]&&(i+=(n-r[0])*(n-r[0])),n=e[1],n<t[1]&&(i+=(t[1]-n)*(t[1]-n)),n>r[1]&&(i+=(n-r[1])*(n-r[1])),n=e[2],n<t[2]&&(i+=(t[2]-n)*(t[2]-n)),n>r[2]&&(i+=(n-r[2])*(n-r[2])),i},e.intersectSphereAABB=function(t,r,i,n){var a=e.sqDistPointAABB(t,i,n);return r*r>=a},e.toLocal=function(e,t){var r=t[0],i=t[1],n=t[2],a=t[4],o=t[5],u=t[6],s=t[8],c=t[9],f=t[10],l=t[12],m=t[13],E=t[14],d=vec3.create();return d[0]=r*e[0]+i*e[1]+n*e[2]+(r*-l+i*-m+n*-E),d[1]=a*e[0]+o*e[1]+u*e[2]+(a*-l+o*-m+u*-E),d[2]=s*e[0]+c*e[1]+f*e[2]+(s*-l+c*-m+f*-E),d},e.degToRad=function(e){return e*Math.PI/180},e}(),GBuffer=function(){"use strict";var e,t,r,i,n,a,o,u,s,c=function(){r=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,u,s,0,e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,null),i=e.createTexture(),e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u,s,0,e.RGBA,e.FLOAT,null),n=e.createTexture(),e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u,s,0,e.RGBA,e.FLOAT,null),a=e.createTexture(),e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u,s,0,e.RGBA,e.FLOAT,null),o=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,o),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0),e.framebufferTexture2D(e.FRAMEBUFFER,t.drawBuffers.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,i,0),e.framebufferTexture2D(e.FRAMEBUFFER,t.drawBuffers.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,n,0),e.framebufferTexture2D(e.FRAMEBUFFER,t.drawBuffers.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,a,0);var c=e.checkFramebufferStatus(e.FRAMEBUFFER);c!==e.FRAMEBUFFER_COMPLETE&&alert("Invalid FBO status: "+c),e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null)},f=function(){e.bindFramebuffer(e.FRAMEBUFFER,o),t.drawBuffers.drawBuffersWEBGL([t.drawBuffers.COLOR_ATTACHMENT0_WEBGL,t.drawBuffers.COLOR_ATTACHMENT1_WEBGL,t.drawBuffers.COLOR_ATTACHMENT2_WEBGL])},l=function(){e.bindFramebuffer(e.FRAMEBUFFER,null)},m=function(){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,u,s,0,e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,null),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u,s,0,e.RGBA,e.FLOAT,null),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u,s,0,e.RGBA,e.FLOAT,null),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u,s,0,e.RGBA,e.FLOAT,null),e.bindTexture(e.TEXTURE_2D,null)},E=function(e,t){u=e,s=t,m()},d=function(){return r},T=function(){return i},R=function(){return n},x=function(){return a},v=function(r,i,n){e=r,t=i,u=n.width,s=n.height,c()};return{init:v,bindGeometryPass:f,unbindGeometryPass:l,resize:E,getDepthTexture:d,getNormalTexture:T,getPositionTexture:R,getColorTexture:x}}(),ShaderLoader=function(e){"use strict";var t,r={},i=function(e,r){var i=t.createShader(r);if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw t.getShaderInfoLog(i);return i},n=function(e,r){var n=t.createProgram(),a=i(e,t.VERTEX_SHADER),o=i(r,t.FRAGMENT_SHADER);if(t.attachShader(n,a),t.attachShader(n,o),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw t.getProgramInfoLog(n);return n},a=function(t){return e.ajax(t,{dataType:"text"})},o=function(t,i,o,u){return e.when(a(i),a(o)).done(function(e,i){var a=n(e[0],i[0]);u(a),r[t]=a})},u=function(e){return r[e]},s=function(e){t=e};return{loadProgram:o,getShader:u,init:s}}(jQuery),DeferredRenderer=function(e,t,r,i){"use strict";var n,a,o,u,s,c,f=function(){var e=[-1,-1,0,1,-1,0,1,1,0,-1,1,0],t=[0,1,2,0,2,3];a=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,new Float32Array(e),n.STATIC_DRAW),a.itemSize=3,a.numItems=e.length/3,o=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,o),n.bufferData(n.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),n.STATIC_DRAW),o.itemSize=1,o.numItems=t.length},l=function(e,t){for(var r=16,i=[],a=0;a<e.length;a++){for(var o=e[a].position,f=t.getObjectGridIndex3D(o),l=[],m=-1;2>m;m++)for(var E=-1;2>E;E++)for(var d=-1;2>d;d++){var T=f[0]+m,R=f[1]+E,x=f[2]+d;if(T>=0&&R>=0&&x>=0&&T<t.numBoxesX&&R<t.numBoxesY&&x<t.numBoxesZ){var v=parseInt(x*t.numBoxesX*t.numBoxesY+R*t.numBoxesX+T);if(void 0===t.cells[v])continue;for(var h=0;h<t.cells[v].length;h++)l.push(t.cells[v][h])}}i[a]=[];for(var h=0;h<l.length;h++){var A=l[h];if(a!==A){var U=e[A].position,g=vec3.create();vec3.subtract(g,o,U);var _=vec3.squaredLength(g),M={id:A,dist:_,position:U,radius:e[A].radius};i[a].push(M)}}}for(var B=function(e,t){return e.dist-t.dist},a=0;a<i.length;a++)i[a].sort(B);for(var b=2048,p=parseInt((e.length+b-1)/b),D=p*r,F=new Float32Array(b*D*4),P=0,a=0,L=0;p>a;a++,L+=r)for(var h=0;b>h;h++){if(P<e.length)for(var S=0;S<i[P].length;S++)r>S&&(F[4*h+0+4*(L+S)*b]=i[P][S].position[0],F[4*h+1+4*(L+S)*b]=i[P][S].position[1],F[4*h+2+4*(L+S)*b]=i[P][S].position[2],F[4*h+3+4*(L+S)*b]=i[P][S].radius);P++}s=b,c=D,u=n.createTexture(),n.bindTexture(n.TEXTURE_2D,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,b,D,0,n.RGBA,n.FLOAT,F),n.bindTexture(n.TEXTURE_2D,null)},m=function(e){return e.vertexPositionAttribute=n.getAttribLocation(e,"aPosition"),n.enableVertexAttribArray(e.vertexPositionAttribute),e.mMatrixUniform=n.getUniformLocation(e,"uModelMatrix"),e.vMatrixUniform=n.getUniformLocation(e,"uViewMatrix"),e.pMatrixUniform=n.getUniformLocation(e,"uProjectionMatrix"),e.mvMatrixUniform=n.getUniformLocation(e,"uModelViewMatrix"),e.lightPosUniform=n.getUniformLocation(e,"uLightPos"),e.depthTextureUniform=n.getUniformLocation(e,"uDepthTexture"),e.normalTextureUniform=n.getUniformLocation(e,"uNormalTexture"),e.positionTextureUniform=n.getUniformLocation(e,"uPositionTexture"),e.colorTextureUniform=n.getUniformLocation(e,"uColorTexture"),e.occludersTextureUniform=n.getUniformLocation(e,"uOccludersTexture"),e.occludersTextureSizeUniform=n.getUniformLocation(e,"uOccludersTextureSize"),e.renderModeUniform=n.getUniformLocation(e,"uRenderMode"),e.aoIntensityLocation=n.getUniformLocation(e,"uAOIntensity"),e},E=function(e){return e.vertexPositionAttribute=n.getAttribLocation(e,"aPosition"),n.enableVertexAttribArray(e.vertexPositionAttribute),e.colourUniform=n.getUniformLocation(e,"uColour"),e.mMatrixUniform=n.getUniformLocation(e,"uModelMatrix"),e.vMatrixUniform=n.getUniformLocation(e,"uViewMatrix"),e.pMatrixUniform=n.getUniformLocation(e,"uProjectionMatrix"),e},d=function(){var t=[];return t.push(r.loadProgram("geom-pass","/shaders/geom-pass.vert","/shaders/geom-pass.frag",E)),t.push(r.loadProgram("light-pass","/shaders/light-pass.vert","/shaders/light-pass.frag",m)),e.when.apply(e,t)},T=function(e,i,f,l){var m=vec3.create();vec3.transformMat4(m,i.position,e.vMatrix);var E=mat4.create();mat4.multiply(E,e.vMatrix,f),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.disable(n.DEPTH_TEST);var d=r.getShader("light-pass");n.useProgram(d),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,t.getDepthTexture()),n.uniform1i(d.depthTextureUniform,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,t.getNormalTexture()),n.uniform1i(d.normalTextureUniform,1),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,t.getPositionTexture()),n.uniform1i(d.positionTextureUniform,2),n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,t.getColorTexture()),n.uniform1i(d.colorTextureUniform,3),n.activeTexture(n.TEXTURE4),n.bindTexture(n.TEXTURE_2D,u),n.uniform1i(d.occludersTextureUniform,4),n.uniform2f(d.occludersTextureSizeUniform,s,c),n.uniform3f(d.lightPosUniform,m[0],m[1],m[2]),n.uniformMatrix4fv(d.mMatrixUniform,!1,f),n.uniformMatrix4fv(d.vMatrixUniform,!1,e.vMatrix),n.uniformMatrix4fv(d.mvMatrixUniform,!1,E),n.uniform1i(d.renderModeUniform,l.mode),n.uniform1f(d.aoIntensityLocation,l.aoIntensity),n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(d.vertexPositionAttribute,a.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,o),n.drawElements(n.TRIANGLES,o.numItems,n.UNSIGNED_SHORT,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),n.bindBuffer(n.ARRAY_BUFFER,null),n.useProgram(null)},R=function(){t.bindGeometryPass(),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.DEPTH_TEST)},x=function(){t.unbindGeometryPass()},v=function(e,r){t.resize(e,r)},h=function(r,i,a){return n=r,t.init(n,i,{width:a.width,height:a.height}),f(),e.when(d())};return{init:h,resize:v,calcOccluders:l,beginGeometryPass:R,endGeometryPass:x,renderLightPass:T}}(jQuery,GBuffer,ShaderLoader,Utilities),MoleculeLoader=function(e){"use strict";var t=[],r={pdbID:"",title:""},i={AG:1.72,AR:1.85,AS:1.85,AU:1.66,BR:1.85,C:1.7,CD:1.58,CL:1.75,CU:1.4,F:1.47,FE:1.47,GA:1.87,H:1.2,HE:1.4,HG:1.55,I:1.98,IN:1.93,K:2.75,KR:2.02,LI:1.82,MG:1.73,N:1.55,NA:2.27,NE:1.54,NI:1.63,O:1.52,P:1.8,PB:2.02,PD:1.63,PT:1.72,S:1.8,SE:1.9,SI:2.1,SN:2.17,TE:2.06,TL:1.96,U:1.86,XE:2.16,ZN:1.39},n=[200/255,200/255,200/255],a=[240/255,0,0],o=[1,1,1],u=[143/255,143/255,1],s=[1,200/255,50/255],c=[1,165/255,0],f=[0,1,0],l=[165/255,42/255,42/255],m=[0,0,1],E=[42/255,128/255,42/255],d=[128/255,128/255,128/255],T=[1,20/255,147/255],R={C:n,O:a,H:o,N:u,S:s,P:c,CL:f,BR:l,ZN:l,NA:m,FE:c,F:c,MG:E,CA:d,UNKNOWN:T},x=function(e){var n=e.split("\n");t.length=0;for(var a=0;a<n.length;a++){var o=n[a],u=o.substr(0,6).trim();if("ATOM"===u||"HETATM"===u){var s=parseInt(o.substr(6,5).trim()),c=o.substr(12,4).trim(),f=o.substr(17,3).trim(),l=o.substr(21,1).trim(),m=parseInt(o.substr(22,5).trim()),E=parseFloat(o.substr(30,8).trim()),d=parseFloat(o.substr(38,8).trim()),T=parseFloat(o.substr(46,8).trim()),x=parseFloat(o.substr(60,8).trim()),v=o.substr(76,2).trim();""===v&&(v=c);var h=!1;"H"===o[0]&&(h=!0);var A=i[v],U=R[v];void 0===U&&(U=[.5,.5,.5]),void 0===x&&(x=1);var g={serial:s,atom:c,resName:f,chainID:l,residue:m,position:vec3.fromValues(E,d,T),radius:A,element:v,colourCPK:U,colour:U,hetFlag:h,selected:!1};t.push(g)}else"HEADER"===u?r.pdbID=o.substr(62,4):"TITLE"===u&&(r.title=o.substr(10,70))}},v=function(t){if(r.pdbID=t.toUpperCase(),!r.pdbID.match(/^[1-9][A-Za-z0-9]{3}$/))return alert("Invalid PDB ID"),e.Deferred().reject("Invalid PDB ID");var i="http://www.rcsb.org/pdb/files/"+r.pdbID+".pdb";return e.ajax(i,{dataType:"text"}).done(function(e){x(e)})},h=function(e){for(var r=0;r<t.length;r++)vec3.subtract(t[r].position,t[r].position,e)},A=function(){for(var e=vec3.create(),r=0;r<t.length;r++)vec3.add(e,e,t[r].position);return vec3.divide(e,e,vec3.fromValues(t.length,t.length,t.length)),e},U=function(e){for(var r=0,i=0;i<t.length;i++){var n=vec3.create();vec3.subtract(n,e,t[i].position);var a=vec3.length(n);a>r&&(r=a)}return r},g=function(){var e=t[0].position,r=t[0].radius,i=vec3.create();i[0]=e[0]-r,i[1]=e[1]-r,i[2]=e[2]-r;var n=vec3.create();n[0]=e[0]+r,n[1]=e[1]+r,n[2]=e[2]+r;for(var a=1;a<t.length;a++){var o=t[a].position,u=t[a].radius;o[0]-u<i[0]?i[0]=o[0]-u:o[0]+u>n[0]&&(n[0]=o[0]+u),o[1]-u<i[1]?i[1]=o[1]-u:o[1]+u>n[1]&&(n[1]=o[1]+u),o[2]-u<i[2]?i[2]=o[2]-u:o[2]+u>n[2]&&(n[2]=o[2]+u)}return{min:i,max:n}},_=function(){for(var e=t[0].radius,r=1;r<t.length;r++)t[r].radius>e&&(e=t[r].radius);return e},M=function(){return{atoms:t,protein:r}};return{download:v,parsePDBFile:x,getMolecule:M,centerMoleculeOnMidPoint:h,getBoundingBox:g,getMaxRadius:_,getMidPoint:A,getFurthestDistanceToMidPoint:U}}(jQuery),MoleculeRenderer=function(e,t){"use strict";var r,i,n,a=function(){var e=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];i=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,i),r.bufferData(r.ARRAY_BUFFER,new Float32Array(e),r.STATIC_DRAW),i.itemSize=3,i.numItems=e.length/3,n=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),r.STATIC_DRAW),n.itemSize=1,n.numItems=t.length},o=function(e){return e.vertexPositionAttribute=r.getAttribLocation(e,"aPosition"),r.enableVertexAttribArray(e.vertexPositionAttribute),e.instancePositionUniform=r.getUniformLocation(e,"uInstancePosition"),e.radiusUniform=r.getUniformLocation(e,"uRadius"),e.atomIdUniform=r.getUniformLocation(e,"uAtomId"),e.colourUniform=r.getUniformLocation(e,"uColour"),e.mMatrixUniform=r.getUniformLocation(e,"uModelMatrix"),e.vMatrixUniform=r.getUniformLocation(e,"uViewMatrix"),e.pMatrixUniform=r.getUniformLocation(e,"uProjectionMatrix"),e},u=function(){return t.loadProgram("molecule","/shaders/molecule.vert","/shaders/molecule.frag",o)},s=function(e,a,o){var u=t.getShader("molecule");r.useProgram(u),r.uniformMatrix4fv(u.mMatrixUniform,!1,o),r.uniformMatrix4fv(u.vMatrixUniform,!1,a.vMatrix),r.uniformMatrix4fv(u.pMatrixUniform,!1,a.pMatrix),r.bindBuffer(r.ARRAY_BUFFER,i),r.vertexAttribPointer(u.vertexPositionAttribute,i.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n);for(var s=0;s<e.length;s++)r.uniform3f(u.instancePositionUniform,e[s].position[0],e[s].position[1],e[s].position[2]),r.uniform1f(u.radiusUniform,e[s].radius),r.uniform1f(u.atomIdUniform,s),r.uniform3f(u.colourUniform,e[s].colour[0],e[s].colour[1],e[s].colour[2]),r.drawElements(r.TRIANGLES,n.numItems,r.UNSIGNED_SHORT,0);r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,null),r.useProgram(null)},c=function(t){return r=t,a(),e.when(u())};return{init:c,initShader:o,render:s}}(jQuery,ShaderLoader),GridRenderer=function(e,t,r){"use strict";var i,n,a,o=function(){var e=[0,0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,1,0,1,1,0,1,0,0],t=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,7,2,6,3,5];n=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW),n.itemSize=3,n.numItems=e.length/3,a=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),i.STATIC_DRAW),a.itemSize=1,a.numItems=t.length},u=function(e){return e.vertexPositionAttribute=i.getAttribLocation(e,"aPosition"),i.enableVertexAttribArray(e.vertexPositionAttribute),e.instancePositionUniform=i.getUniformLocation(e,"uInstancePosition"),e.colourUniform=i.getUniformLocation(e,"uColour"),e.cellSizeUniform=i.getUniformLocation(e,"uCellSize"),e.mMatrixUniform=i.getUniformLocation(e,"uModelMatrix"),e.vMatrixUniform=i.getUniformLocation(e,"uViewMatrix"),e.pMatrixUniform=i.getUniformLocation(e,"uProjectionMatrix"),e},s=function(){return t.loadProgram("grid","/shaders/grid.vert","/shaders/grid.frag",u)},c=function(e,o,u,s){var c=t.getShader("grid");i.useProgram(c),i.uniformMatrix4fv(c.mMatrixUniform,!1,u),i.uniformMatrix4fv(c.vMatrixUniform,!1,o.vMatrix),i.uniformMatrix4fv(c.pMatrixUniform,!1,o.pMatrix),i.bindBuffer(i.ARRAY_BUFFER,n),i.vertexAttribPointer(c.vertexPositionAttribute,n.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a);var f=mat4.create(),l=mat4.create();mat4.multiply(l,o.pMatrix,o.vMatrix),mat4.invert(f,l);var m=vec3.fromValues(o.position[0],o.position[1],o.position[2]),E=r.getEyeRay(o.position,f,s.mouse.lastX/s.screenWidth*2-1,1-s.mouse.lastY/s.screenHeight*2);vec3.normalize(E,E);var d=vec3.create(),T=vec3.fromValues(e.numBoxesX,e.numBoxesY,e.numBoxesZ);vec3.scale(d,T,e.cellSize),vec3.add(d,d,e.min);var R=r.toLocal(m,u),x=r.toLocal(E,u),v=r.intersectRayAABB(R,x,e.min,d);if(v.t0+=.001,v.hit){var h=e.getObjectGridIndex3D(R),A=h[0],U=h[1],g=h[2];if(!e.insideGrid(A,U,g)){var _=vec3.create();vec3.scale(_,x,v.t0),vec3.add(R,R,_),h=e.getObjectGridIndex3D(R),A=h[0],U=h[1],g=h[2]}for(var M=Math.abs(e.cellSize/x[0]),B=Math.abs(e.cellSize/x[1]),b=Math.abs(e.cellSize/x[2]),p=(x[0]>0)-(x[0]<0),D=(x[1]>0)-(x[1]<0),F=(x[2]>0)-(x[2]<0),P=e.getCellMinPoint(A,U,g),L=e.getCellMaxPoint(A,U,g),S=(P[0]-R[0])/x[0],I=(P[1]-R[1])/x[1],X=(P[2]-R[2])/x[2],w=(L[0]-R[0])/x[0],G=(L[1]-R[1])/x[1],N=(L[2]-R[2])/x[2],O=x[0]<0?S:w,z=x[1]<0?I:G,C=x[2]<0?X:N,y=!1;!y;)i.uniform3f(c.instancePositionUniform,e.min[0]+A*e.cellSize,e.min[1]+U*e.cellSize,e.min[2]+g*e.cellSize),i.uniform3f(c.colourUniform,0,0,1),i.uniform1f(c.cellSizeUniform,e.cellSize),i.drawElements(i.LINES,a.numItems,i.UNSIGNED_SHORT,0),z>O?C>O?(A+=p,O+=M):(g+=F,C+=b):C>z?(U+=D,z+=B):(g+=F,C+=b),y=!e.insideGrid(A,U,g)}for(var Y=0;Y<e.numBoxesX;Y++)for(var H=0;H<e.numBoxesY;H++)for(var W=0;W<e.numBoxesZ;W++)i.uniform3f(c.instancePositionUniform,e.min[0]+Y*e.cellSize,e.min[1]+H*e.cellSize,e.min[2]+W*e.cellSize),i.uniform3f(c.colourUniform,.5,.5,.5),i.uniform1f(c.cellSizeUniform,e.cellSize),i.drawElements(i.LINES,a.numItems,i.UNSIGNED_SHORT,0);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),i.bindBuffer(i.ARRAY_BUFFER,null),i.useProgram(null)},f=function(t){return i=t,o(),e.when(s())};return{init:f,render:c,initShader:u}}(jQuery,ShaderLoader,Utilities),Viewer=function(e,t,r,i,n,a,o){"use strict";var u,s,c,f,l={},m={canvas:"#canvas",width:512,height:512},E=!1,d={aoIntensity:.25,altitude:60,azimuth:60,renderGrid:!1,mode:5},T={},R=[],x={vMatrix:mat4.create(),pMatrix:mat4.create(),position:vec3.create(),vpMatrix:mat4.create(),inverseVPMatrix:mat4.create(),zoom:0},v={position:vec3.fromValues(0,0,1),vMatrix:mat4.create(),pMatrix:mat4.create()},h=mat4.create(),A=mat4.create(),U={},g={},_=-1,M={down:!1,lastX:null,lastY:null},B=function(){c=u.createBuffer(),u.bindBuffer(u.ARRAY_BUFFER,c);var e=[-1,0,1,1,0,1,-1,0,-1,1,0,-1];u.bufferData(u.ARRAY_BUFFER,new Float32Array(e),u.STATIC_DRAW),c.itemSize=3,c.numItems=4},b=function(){var e=r.getShader("geom-pass");u.useProgram(e),mat4.identity(A),mat4.translate(A,A,[0,-f,0]),mat4.scale(A,A,[3*f,1,3*f]),u.uniformMatrix4fv(e.mMatrixUniform,!1,A),u.uniformMatrix4fv(e.vMatrixUniform,!1,x.vMatrix),u.uniformMatrix4fv(e.pMatrixUniform,!1,x.pMatrix),u.uniform3f(e.colourUniform,.5,.5,.5),u.bindBuffer(u.ARRAY_BUFFER,c),u.vertexAttribPointer(e.vertexPositionAttribute,c.itemSize,u.FLOAT,!1,0,0),u.drawArrays(u.TRIANGLE_STRIP,0,c.numItems),u.bindBuffer(u.ARRAY_BUFFER,null),u.useProgram(null)},p=function(){E=!1,t.beginGeometryPass(),mat4.identity(x.vMatrix),mat4.lookAt(x.vMatrix,x.position,[0,0,0],[0,1,0]),mat4.perspective(x.pMatrix,45,m.width/m.height,1,1e3),n.render(R,x,h),b(),d.renderGrid&&a.render(U,x,h,{screenWidth:m.width,screenHeight:m.height,mouse:M}),t.endGeometryPass();var e=o.degToRad(d.azimuth),r=o.degToRad(d.altitude);v.position[0]=1.2*x.zoom*Math.sin(r)*Math.cos(e),v.position[1]=1.2*x.zoom*Math.cos(r),v.position[2]=1.2*x.zoom*Math.sin(r)*Math.sin(e),t.renderLightPass(x,v,h,d)},D=function(){E||(E=!0,window.requestAnimationFrame(p))},F=function(){var e=i.getBoundingBox(),t=i.getMaxRadius();U=new Grid,U.init(e.min,e.max,2*t);for(var r=0;r<R.length;r++){var n=U.getObjectGridIndex3D(R[r].position);if(U.insideGrid(n[0],n[1],n[2])){var a=parseInt(n[2]*U.numBoxesX*U.numBoxesY+n[1]*U.numBoxesX+n[0]);void 0===U.cells[a]&&(U.cells[a]=[]),U.cells[a].push(parseInt(r))}}g=new Grid,g.init(e.min,e.max,2*t);for(var r=0;r<R.length;r++)for(var u=g.getObjectGridIndex3D(R[r].position),s=-1;2>s;s++)for(var c=-1;2>c;c++)for(var f=-1;2>f;f++){var l=u[0]+s,m=u[1]+c,E=u[2]+f;if(g.insideGrid(l,m,E)){var d=g.getCellMinPoint(l,m,E),T=g.getCellMaxPoint(l,m,E);if(o.intersectSphereAABB(R[r].position,R[r].radius,d,T)){var a=E*g.numBoxesX*g.numBoxesY+m*g.numBoxesX+l;void 0===g.cells[a]&&(g.cells[a]=[]),g.cells[a].push(parseInt(r))}}}},P=function(e,t){mat4.multiply(x.vpMatrix,x.pMatrix,x.vMatrix),mat4.invert(x.inverseVPMatrix,x.vpMatrix);var r=vec3.fromValues(x.position[0],x.position[1],x.position[2]),i=o.getEyeRay(x.position,x.inverseVPMatrix,e/m.width*2-1,1-t/m.height*2);vec3.normalize(i,i),_=-1;var n=Number.MAX_VALUE,a=vec3.create(),u=vec3.fromValues(g.numBoxesX,g.numBoxesY,g.numBoxesZ);vec3.scale(a,u,g.cellSize),vec3.add(a,a,g.min);var s=o.toLocal(r,h),c=o.toLocal(i,h),f=o.intersectRayAABB(s,c,U.min,a);if(f.t0+=.001,f.hit){var l=g.getObjectGridIndex3D(s),E=l[0],d=l[1],T=l[2];if(!g.insideGrid(E,d,T)){var v=vec3.create();vec3.scale(v,c,f.t0),vec3.add(s,s,v),l=g.getObjectGridIndex3D(s),E=l[0],d=l[1],T=l[2]}for(var A=Math.abs(g.cellSize/c[0]),M=Math.abs(g.cellSize/c[1]),B=Math.abs(g.cellSize/c[2]),b=(c[0]>0)-(c[0]<0),p=(c[1]>0)-(c[1]<0),D=(c[2]>0)-(c[2]<0),F=g.getCellMinPoint(E,d,T),P=g.getCellMaxPoint(E,d,T),L=(F[0]-s[0])/c[0],S=(F[1]-s[1])/c[1],I=(F[2]-s[2])/c[2],X=(P[0]-s[0])/c[0],w=(P[1]-s[1])/c[1],G=(P[2]-s[2])/c[2],N=c[0]<0?L:X,O=c[1]<0?S:w,z=c[2]<0?I:G,C=!1,y=!1;!C;){var Y=parseInt(T*g.numBoxesX*g.numBoxesY+d*g.numBoxesX+E),H=g.cells[Y];if(void 0!==H)for(var W=0;W<H.length;W++){var j=H[W],V=o.intersectRaySphere(s,c,R[j].position,R[j].radius);R[j].tested=!0,n>V&&(n=V,_=j,y=!0)}O>N?z>N?(E+=b,N+=A):(T+=D,z+=B):z>O?(d+=p,O+=M):(T+=D,z+=B),C=!g.insideGrid(E,d,T)||y}}return R[_]},L=function(){T=i.getMolecule(),R=T.atoms;var e=i.getMidPoint(),r=i.getMaxRadius(),n=i.getFurthestDistanceToMidPoint(e);f=n+r,x.position[2]=x.zoom=n/Math.tan(22.5*(Math.PI/180))+r,i.centerMoleculeOnMidPoint(e),mat4.identity(h),F(),t.calcOccluders(R,U)},S=function(e){1===e.which&&(M.down=!0)},I=function(e){1===e.which&&(M.down=!1)},X=function(e){if(D(),M.down){var t=mat4.create(),r=e.clientX-M.lastX;mat4.rotate(t,t,o.degToRad(r/10),[0,1,0]);var i=e.clientY-M.lastY;mat4.rotate(t,t,o.degToRad(i/10),[1,0,0]),mat4.multiply(h,t,h)}M.lastX=e.clientX,M.lastY=e.clientY},w=function(e){D();var t=e.originalEvent.wheelDelta?e.originalEvent.wheelDelta/40:e.originalEvent.detail?-e.originalEvent.detail:0;x.position[2]-=.5*t},G=function(){return s[0].toDataURL("image/jpeg")},N=function(t){d=e.extend({},d,t)},O=function(){s.on("mousedown",S),s.on("mouseup",I),s.on("mousemove",X),s.bind("mousewheel DOMMouseScroll",w)},z=function(e){i.parsePDBFile(e),L(),D()},C=function(e){return i.download(e).done(function(){L(),D()})},y=function(){return i.getMolecule().protein},Y=function(){u.clearColor(1,1,1,1),u.enable(u.DEPTH_TEST),u.enable(u.CULL_FACE),u.frontFace(u.CCW),u.depthMask(!0),u.clearDepth(1),u.disable(u.BLEND)},H=function(){return l.fragDepth=u.getExtension("EXT_frag_depth"),l.drawBuffers=u.getExtension("WEBGL_draw_buffers"),l.textureFloat=u.getExtension("OES_texture_float"),l.textureFloatLinear=u.getExtension("OES_texture_float_linear"),l.depthTexture=u.getExtension("WEBGL_depth_texture"),l.fragDepth&&l.drawBuffers&&l.textureFloat&&l.textureFloatLinear&&l.depthTexture},W=function(e,r){D(),s[0].width=e,s[0].height=r,m.width=e,m.height=r,t.resize(e,r),u.viewport(0,0,e,r),mat4.perspective(x.pMatrix,45,e/r,1,1e3)},j=function(i){if(m=e.extend({},m,i),s=e(m.canvas),u=s[0].getContext("experimental-webgl",{preserveDrawingBuffer:!0}),!u||!H())return e.Deferred().reject("Could not initialise WebGL.");Y(),B(),O(),r.init(u);var o=[];return o.push(t.init(u,l,{width:m.width,height:m.height}),a.init(u),n.init(u)),e.when.apply(e,o).done(function(){W(m.width,m.height)})};return{init:j,updateRenderSettings:N,getImageDataURL:G,loadFromFile:z,download:C,getProtein:y,requestRedraw:D,resize:W,picking:P}}(jQuery,DeferredRenderer,ShaderLoader,MoleculeLoader,MoleculeRenderer,GridRenderer,Utilities),UI=function(e,t){"use strict";var r=new FileReader,i="http://www.rcsb.org/pdb/explore/explore.do?structureId=",n=e("#file-input"),a=e("#file-info"),o=e("#atom-info"),u=e("#load-molecule"),s=e("#pdb-id"),c=e("#loading"),f=function(e){a.html('<a href="'+i+e.pdbID+'" target="_blank">'+e.pdbID+"</a><br>"+e.title)},l=function(e){void 0!==e&&o.html(e.atom+"<br>"+e.resName+"<br>"+e.chainID+"<br>"+e.residue)},m=function(){c.show()},E=function(){c.hide()},d=function(e){r.onerror=function(t){switch(t.target.error.code){case e.target.error.NOT_FOUND_ERR:alert("File Not Found!");break;case t.target.error.NOT_READABLE_ERR:alert("File is not readable");break;case t.target.error.ABORT_ERR:break;default:alert("An error occurred reading this file.")}},r.onabort=function(){alert("File read cancelled")},r.onload=function(e){m(),t.loadFromFile(e.target.result),f(t.getProtein()),E()},r.readAsText(e.target.files[0])},T=function(){var e=s.val();e&&(m(),t.download(e).done(function(){f(t.getProtein())}).always(E))},R=function(){var r={};e(".ui-control").on("change",function(){var i=e(this),n=i.attr("type"),a=i.data("storage-key"),o=i.val();"checkbox"===n&&(o=i.prop("checked")),r[a]=o,window.localStorage.setItem(a,o),t.updateRenderSettings(r),t.requestRedraw()}),n.on("change",d),u.on("click",T)},x=function(){var r={};e(".ui-control").each(function(){var t=e(this),i=t.attr("type"),n=t.data("storage-key"),a=window.localStorage.getItem(n);if(a&&(t.val(a),r[n]=a,"checkbox"===i)){var o="true"===a;t.prop("checked",o),r[n]=o}}),t.updateRenderSettings(r)},v=function(){x(),R()};return{init:v,download:T,updateFileInfo:f,updateAtomInfo:l,showLoading:m,hideLoading:E}}(jQuery,Viewer);